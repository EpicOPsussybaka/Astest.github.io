<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorer — Aether Black Theme (640x360)</title>
  <style>
    :root{--bg:#0b0b0c;--panel:#0f1113;--muted:#9aa4ad;--accent:#1a73e8;--glass:rgba(255,255,255,0.03);font-family:Segoe UI, Inter, system-ui, -apple-system, "Segoe UI";}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;display:flex;align-items:center;justify-content:center}
    /* fixed 640x360 app */
    .window{width:640px;height:360px;background:linear-gradient(180deg,#0e0f10,#0b0b0c);border-radius:8px;box-shadow:0 18px 40px rgba(0,0,0,0.6);overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
    .titlebar{height:36px;background:linear-gradient(90deg,#111214,#0c0c0d);display:flex;align-items:center;padding:6px 8px;gap:8px}
    .titlebar .icon{width:20px;height:20px}
    .title{flex:1;font-weight:600}
    .toolbar{display:flex;align-items:center;gap:6px;padding:8px;background:transparent;border-bottom:1px solid rgba(255,255,255,0.02)}
    .btn{background:#151617;border:1px solid rgba(255,255,255,0.02);color:var(--muted);padding:6px 8px;border-radius:6px;cursor:pointer;font-size:13px}
    .btn.primary{background:linear-gradient(180deg,#1a73e8,#1059c6);color:white;border:none}
    .addr{flex:1;background:#0c0d0e;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .body{display:flex;flex:1;overflow:hidden}
    .sidebar{width:180px;background:linear-gradient(180deg,#0e0f10,#0b0b0c);padding:8px;border-right:1px solid rgba(255,255,255,0.02);overflow:auto}
    .side-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;color:var(--muted)}
    .side-item:hover{background:rgba(255,255,255,0.02)}
    .main{flex:1;padding:8px;display:flex;flex-direction:column;gap:8px}
    .breadcrumb{font-size:13px;color:var(--muted)}
    .content{flex:1;display:flex;gap:8px;overflow:hidden}
    .files-pane{flex:1;background:transparent;overflow:auto;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
    .files-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px}
    .card{background:transparent;padding:6px;border-radius:6px;text-align:center;color:var(--muted);cursor:pointer}
    .card:hover{background:rgba(255,255,255,0.02)}
    .card.selected{outline:2px solid rgba(26,115,232,0.35);background:linear-gradient(180deg,rgba(26,115,232,0.06),transparent);color:#e6eef6}
    .card img{width:56px;height:56px;object-fit:cover;border-radius:6px}
    .details{width:220px;background:linear-gradient(180deg,#0f1113,#0c0c0d);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);overflow:auto}
    .muted{color:var(--muted);font-size:13px}
    .status{height:28px;padding:4px 8px;background:#0e0f10;border-top:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;font-size:13px;color:var(--muted)}
    input[type="text"], textarea{width:100%;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#e6eef6;padding:6px;border-radius:6px;resize:vertical}
    /* small */
    .small{font-size:12px}
    .status-msg{font-size:12px;color:var(--muted);margin-left:8px}
  </style>
</head>
<body>
  <div class="window" role="application">
    <div class="titlebar">
      <img class="icon" src="https://img.icons8.com/fluency/48/folder-invoices.png" alt="icon"/>
      <div class="title">File Explorer — This PC (C:)</div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="min">—</button>
        <button class="btn" id="max">□</button>
        <button class="btn" id="close">✕</button>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn" id="back">◀</button>
      <button class="btn" id="forward">▶</button>
      <button class="btn" id="up">⬆</button>

      <div class="addr" id="addr">C:\</div>

      <button class="btn" id="newFolder">New Folder</button>
      <button class="btn" id="newFile">New File</button>
      <button class="btn" id="deleteBtn">Delete</button>
      <button class="btn primary" id="downloadBtn">Save to Disk</button>
      <button class="btn" id="cloudSave">Cloud Save</button>
      <button class="btn" id="cloudLoad">Cloud Load</button>
      <div class="status-msg" id="statusMsg">Cloud: disconnected</div>
    </div>

    <div class="body">
      <div class="sidebar">
        <div class="side-item" data-path="This PC"><img src="https://img.icons8.com/fluency/48/folder-invoices.png" width="20"/>This PC</div>
        <div class="side-item" data-path="Documents"><img src="https://img.icons8.com/fluency/48/documents.png" width="20"/>Documents</div>
        <div class="side-item" data-path="Pictures"><img src="https://img.icons8.com/fluency/48/picture.png" width="20"/>Pictures</div>
        <div class="side-item" data-path="Music"><img src="https://img.icons8.com/fluency/48/musical-notes.png" width="20"/>Music</div>
      </div>

      <div class="main">
        <div class="breadcrumb" id="breadcrumb">C:\</div>
        <div class="content">
          <div class="files-pane" id="filesPane">
            <div class="files-grid" id="filesGrid"></div>
          </div>

          <div class="details" id="detailsPane">
            <div style="font-weight:600">Details</div>
            <div id="detailsContent" class="muted small">Select a file or folder to see details</div>
            <hr/>
            <div style="margin-top:8px"><label class="small">Editor (text files)</label><textarea id="editor" rows="6" placeholder="Select a .txt file to edit..." disabled></textarea>
            <div style="display:flex;gap:6px;margin-top:6px"><button class="btn" id="saveChanges">Save</button><button class="btn" id="clearEditor">Clear</button></div></div>
          </div>
        </div>

      </div>
    </div>

    <div class="status"><div id="count">0 items</div><div id="space">Free space: 120 GB</div></div>
  </div>

  <script>
    // Virtual C: drive stored in localStorage under key 'vfs_c'
    const STORAGE_KEY = 'vfs_c';
    const CLOUD_KEY = 'vfs_c_cloud_backup';
    const WS_URL = 'wss://clouddata.turbowarp.org';

    // default structure
    const DEFAULT_FS = {
      name: 'C:',
      type: 'drive',
      children: {
        'Documents': {name:'Documents', type:'folder', children:{
           'Resume.pdf': {name:'Resume.pdf', type:'file', mime:'application/pdf', size:'72 KB', content:''},
           'Notes.txt': {name:'Notes.txt', type:'file', mime:'text/plain', size:'4 KB', content:'These are some notes.'}
        }},
        'Pictures': {name:'Pictures', type:'folder', children:{'Landscape.jpg':{name:'Landscape.jpg', type:'file', mime:'image/jpeg', size:'2.1 MB', content:''}}},
        'Music': {name:'Music', type:'folder', children:{}}
      }
    };

    // load or init
    let vfs = loadFS();
    let currentPath = ['C:'];
    let selected = null;
    let history = [];
    let historyIdx = -1;

    // websocket client (for cloud save/load)
    let ws = null;
    let wsOpen = false;
    const statusMsgEl = document.getElementById('statusMsg');

    function connectWS(){
      if(wsOpen) return;
      try{
        ws = new WebSocket(WS_URL);
        statusMsgEl.textContent = 'Cloud: connecting...';
        ws.onopen = ()=>{ wsOpen = true; statusMsgEl.textContent = 'Cloud: connected'; console.log('WS open'); };
        ws.onclose = ()=>{ wsOpen = false; statusMsgEl.textContent = 'Cloud: disconnected'; console.log('WS closed'); };
        ws.onerror = (e)=>{ console.error('WS error', e); statusMsgEl.textContent = 'Cloud: error'; };
        ws.onmessage = (evt)=>{
          // expecting JSON: {type:'load'|'save'|'error', key:'vfs_c', data:...}
          try{ const msg = JSON.parse(evt.data); handleWSMessage(msg); } catch(e){ console.warn('Invalid WS message', evt.data); }
        };
      }catch(e){ console.error('WS connect failed', e); statusMsgEl.textContent='Cloud: failed'; }
    }

    function handleWSMessage(msg){
      if(msg.type === 'save' && msg.status === 'ok'){ alert('Cloud save successful'); }
      else if(msg.type === 'load' && msg.data){ vfs = msg.data; saveFS(); currentPath = ['C:']; selected = null; render(); alert('Cloud load complete'); }
      else if(msg.type === 'error'){ alert('Cloud error: '+(msg.message||'Unknown')); }
    }

    function loadFS(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw); }catch(e){}
      localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_FS)); return JSON.parse(JSON.stringify(DEFAULT_FS));
    }
    function saveFS(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(vfs)); }

    // helpers
    function getNode(pathArr){ let node = vfs; for(let i=1;i<pathArr.length;i++){ const part = pathArr[i]; if(!node.children || !node.children[part]) return null; node = node.children[part]; } return node; }

    function listChildren(node){ if(!node || !node.children) return []; return Object.values(node.children); }

    function pushHistory(){ history = history.slice(0, historyIdx+1); history.push([...currentPath]); historyIdx++; }
    function goHistory(idx){ if(idx<0 || idx>=history.length) return; historyIdx = idx; currentPath = [...history[idx]]; selected=null; render(); }

    function render(){
      const node = getNode(currentPath);
      document.getElementById('breadcrumb').textContent = currentPath.join('\\');
      document.getElementById('addr').textContent = currentPath.join('\\');
      const grid = document.getElementById('filesGrid'); grid.innerHTML='';
      const children = listChildren(node);
      document.getElementById('count').textContent = `${children.length} items`;
      children.forEach(child=>{
        const el = document.createElement('div'); el.className='card'; el.dataset.name=child.name;
        const iconUrl = child.type==='folder'? 'https://img.icons8.com/fluency/96/folder-invoices.png' : (child.mime && child.mime.startsWith('image')? 'https://img.icons8.com/fluency/96/landscape.png' : 'https://img.icons8.com/fluency/96/document.png');
        el.innerHTML = `<img src="${iconUrl}" alt="icon"/><div style='margin-top:6px;font-size:13px'>${child.name}</div><div class='muted small'>${child.type==='folder'? 'Folder' : (child.mime? child.mime.replace('image/','').toUpperCase() : '') + (child.size? ' • '+child.size: '')}</div>`;
        el.onclick = ()=>{ selectItem(child, el); };
        el.ondblclick = ()=>{ if(child.type==='folder'){ currentPath.push(child.name); selected = null; pushHistory(); render(); } else { openFile(child); } };
        grid.appendChild(el);
      });
      updateDetails();
    }

    function selectItem(node, el){ document.querySelectorAll('.card.selected').forEach(x=>x.classList.remove('selected')); if(el){ el.classList.add('selected'); }
      selected = node; updateDetails();
    }

    function updateDetails(){ const details = document.getElementById('detailsContent'); const editor = document.getElementById('editor'); if(!selected){ details.textContent = 'Select a file or folder to see details'; editor.value=''; editor.disabled=true; return; } const info = [];
      info.push('Name: '+selected.name);
      info.push('Type: '+(selected.type==='folder'? 'Folder' : 'File'));
      if(selected.mime) info.push('MIME: '+selected.mime);
      if(selected.size) info.push('Size: '+selected.size);
      details.innerHTML = info.map(i=>'<div class="muted small">'+i+'</div>').join('');
      if(selected.type==='file' && selected.mime === 'text/plain'){ editor.disabled=false; editor.value = selected.content || ''; } else { editor.disabled=true; editor.value=''; }
    }

    function openFile(node){
      // basic text preview or info
      if(node.type==='file' && node.mime==='text/plain'){
        alert('Opening text file: '+node.name+'

'+(node.content||'(empty)'));
      } else {
        alert('Open: '+node.name+"
(For binary files preview is not implemented.)");
      }
    }

    // buttons
    document.getElementById('newFolder').addEventListener('click', ()=>{
      const name = prompt('New folder name','New folder'); if(!name) return;
      const node = getNode(currentPath);
      if(!node.children) node.children={};
      if(node.children[name]){ alert('A file or folder with that name already exists'); return; }
      node.children[name] = {name:name,type:'folder',children:{}}; saveFS(); render();
    });

    document.getElementById('newFile').addEventListener('click', ()=>{
      const name = prompt('New file name','NewFile.txt'); if(!name) return;
      const node = getNode(currentPath);
      if(!node.children) node.children={}; if(node.children[name]){ alert('Already exists'); return; }
      const isTxt = name.toLowerCase().endsWith('.txt');
      node.children[name] = {name:name,type:'file',mime: isTxt? 'text/plain' : 'application/octet-stream', size:'1 KB', content: isTxt? '': ''}; saveFS(); render();
    });

    document.getElementById('deleteBtn').addEventListener('click', ()=>{
      if(!selected){ alert('Select an item to delete'); return; }
      if(!confirm('Delete "'+selected.name+'"?')) return;
      const node = getNode(currentPath);
      if(node && node.children && node.children[selected.name]){ delete node.children[selected.name]; selected=null; saveFS(); render(); }
    });

    document.getElementById('up').addEventListener('click', ()=>{ if(currentPath.length>1){ currentPath.pop(); selected=null; pushHistory(); render(); } });

    // back/forward
    document.getElementById('back').addEventListener('click', ()=>{ if(historyIdx>0) goHistory(historyIdx-1); });
    document.getElementById('forward').addEventListener('click', ()=>{ if(historyIdx < history.length-1) goHistory(historyIdx+1); });

    // download (save to disk)
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      if(!selected || selected.type!=='file'){ alert('Select a file to save to disk'); return; }
      const blob = new Blob([selected.content || ''], {type: selected.mime || 'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = selected.name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // cloud save/load using websocket server provided by user
    function cloudSave(){
      connectWS();
      const payload = {type:'save', key:STORAGE_KEY, data:vfs};
      if(wsOpen){ ws.send(JSON.stringify(payload)); }
      else { // attempt to send after a short delay
        setTimeout(()=>{ if(wsOpen) ws.send(JSON.stringify(payload)); else alert('Cloud connection failed'); }, 800);
      }
    }
    function cloudLoad(){
      connectWS();
      const payload = {type:'load', key:STORAGE_KEY};
      if(wsOpen){ ws.send(JSON.stringify(payload)); }
      else { setTimeout(()=>{ if(wsOpen) ws.send(JSON.stringify(payload)); else alert('Cloud connection failed'); }, 800); }
    }

    document.getElementById('cloudSave').addEventListener('click', ()=>{ if(confirm('Upload virtual C: drive to cloud?')) cloudSave(); });
    document.getElementById('cloudLoad').addEventListener('click', ()=>{ if(confirm('Load virtual C: drive from cloud? This will overwrite local state.')) cloudLoad(); });

    // editor save
    document.getElementById('saveChanges').addEventListener('click', ()=>{
      const editor = document.getElementById('editor'); if(!selected || selected.type!=='file' || selected.mime!=='text/plain'){ alert('Select a text file to save changes'); return; }
      selected.content = editor.value; selected.size = (new Blob([editor.value]).size/1024).toFixed(1)+' KB'; saveFS(); render(); alert('Saved');
    });
    document.getElementById('clearEditor').addEventListener('click', ()=>{ document.getElementById('editor').value=''; });

    // sidebar clicks
    document.querySelectorAll('.side-item').forEach(el=> el.addEventListener('click', ()=>{
      const p = el.dataset.path; if(p==='This PC'){ currentPath=['C:']; } else { currentPath=['C:', p]; }
      selected=null; pushHistory(); render();
    }));

    // websocket connect on load
    connectWS();

    // load initial
    pushHistory(); render();

    // simple keyboard: Delete key deletes
    document.addEventListener('keydown', (e)=>{ if(e.key==='Delete'){ document.getElementById('deleteBtn').click(); } });

    // expose for debugging
    window.vfs = vfs;
  </script>
</body>
</html>
